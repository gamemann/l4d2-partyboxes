A [SourceMod](https://www.sourcemod.net/) plugin for [Left 4 Dead 2](https://store.steampowered.com/app/550/Left_4_Dead_2/) that turns upgrade boxes such as incendiary and explosive ammo boxes into random/fun boxes. There are three categories a box may be registered under which include **Good**, **Mid**, and **Bad**. Good boxes help the survivors, mid boxes are somewhere in-between (misc?), and bad boxes negatively impact the survivors.

You can configure the chance probability for each box category using SourceMod ConVars which is detailed below.

My main goal is to create a modular core plugin that handles things like picking the box and calculating stats, and then allow developers to create their own boxes as separate SourceMod plugins which register with the core via [natives](https://wiki.alliedmods.net/Natives_(SourceMod_Development)) and global [forwards](https://wiki.alliedmods.net/Function_Calling_API_(SourceMod_Scripting)).

**NOTE** - This project is a big **work-in-progress** and I'm also pretty rusty in SourcePawn since I haven't utilized it much in recent years so I'm sure there are many things that can be improved on (feel free to make a PR!).

## Preview
![Test Box](./preview/test-box.gif)

![Damage Box](./preview/dmg-box.gif)

## My Motives
I've been occassionally playing a custom mega (24 players) COOP game server in Left 4 Dead 2 for almost a year now ([Core-SS](https://core-ss.org/forum/)) and I've had a lot of fun! The server runs a custom plugin very similar to this plugin and since I've been wanting to get back into [SourcePawn](https://wiki.alliedmods.net/Introduction_to_SourcePawn_1.7), I figured I'd create my own open source plugin (to my knowledge, the plugin they use isn't open source, but even if it was, I really wanted to make my own to get back into SourcePawn again).

Additionally, I've been really wanting to get back into learning game development so I can create open source 3D games in the future and I really believe creating plugins like this and modding in general can really help with understanding game development further!

## Core
### Config & ConVars
A config file should be generated to `cfg/sourcemod/plugin.l4d2pb.cfg`. Additionally, box-specific configs should be located in the same directory.

Here's the output of the `plugin.l4d2pb.cfg` config file for more information on the current core ConVars.

```bash
// This file was auto-generated by SourceMod (v1.11.0.6968)
// ConVars for plugin "l4d2pb-core.smx"


// The maximum amount of bad boxes that can be opened per round. 0 = disables bad boxes. -1 = no limit.
// -
// Default: "-1"
l4d2_max_bad_boxes "-1"

// Whether to announce who opens boxes.
// -
// Default: "1"
// Minimum: "0.000000"
// Maximum: "1.000000"
l4d2pb_announce "1"

// What type of printing to do for announcing. 0 = chat. 1 = server console. 2 = client console. 3 = hint.
// -
// Default: "3"
// Minimum: "0.000000"
l4d2pb_announce_type "3"

// The chances of a bad box being opened.
// -
// Default: "0.25"
// Minimum: "0.000000"
// Maximum: "1.000000"
l4d2pb_chance_bad "0.25"

// The chances of a good box being opened.
// -
// Default: "0.15"
// Minimum: "0.000000"
// Maximum: "1.000000"
l4d2pb_chance_good "0.15"

// The chances of a mid box being opened.
// -
// Default: "0.50"
// Minimum: "0.000000"
// Maximum: "1.000000"
l4d2pb_chance_mid "0.50"

// The chances of getting no fun boxes when opened.
// -
// Default: "0.10"
// Minimum: "0.000000"
// Maximum: "1.000000"
l4d2pb_chance_none "0.10"

// Enables or disables L4D2 Party Boxes plugin.
// -
// Default: "1"
// Minimum: "0.000000"
// Maximum: "1.000000"
l4d2pb_enabled "1"

// Whether to display stats in chat on round end.
// -
// Default: "1"
// Minimum: "0.000000"
// Maximum: "1.000000"
l4d2pb_end_round_stats "1"

// The maximum amount of good boxes that can be opened per round. 0 = disables good boxes. -1 = no limit.
// -
// Default: "-1"
l4d2pb_max_good_boxes "-1"

// The maximum amount of mid boxes that can be opened per round. 0 = disables mid boxes. -1 = no limit.
// -
// Default: "-1"
l4d2pb_max_mid_boxes "-1"

// The type of max limits. 0 = round-based. 1 = map-based.
// -
// Default: "0"
// Minimum: "0.000000"
// Maximum: "2.000000"
l4d2pb_max_type "0"

// If 1, any boxes that are opened (and not none type) are removed immediately when opened.
// -
// Default: "1"
// Minimum: "0.000000"
// Maximum: "1.000000"
l4d2pb_remove_opened "1"

// The plugin's verbose level.
// -
// Default: "0"
// Minimum: "0.000000"
l4d2pb_verbose "0"

// The type of verbose messages. 0 = prints to chat. 1 = prints to server console. 2 = prints to client's console.
// -
// Default: "0"
// Minimum: "0.000000"
l4d2pb_verbose_type "0"

// The plugin's version.
// -
// Default: "1.0.0"
l4d2pb_version "1.0.0"
```

## Commands
Here are a list of commands you may run from chat (prefixed with `!`) or console (prefixed with `sm_`).

| Command | Admin Only | Arguments | Description |
| ------- | ---------- | --------- | ----------- |
| l4d2pb_stats | No | - | Displays stats in chat. |
| l4d2pb_open | Yes | (1) Box Name | Manually *opens* a box determined by box name argument. Requires root admin flag. |

### Enums
Here are some useful enums you'll need when developing your own box types.

```c
enum BoxType {
    BOXTYPE_NONE = 0,
    BOXTYPE_GOOD = 1,
    BOXTYPE_MID = 2,
    BOXTYPE_BAD = 3
}
```

### Natives
Here are a list of core natives you may use when developing your own box types. Take a look at [`scripting/l4d2pb-box-test.sp`](./scripting/l4d2pb-box-test.sp) for a basic example.

```c
/**
 * Prints a debug message from the core plugin.
 *
 * @param req      The required verbose level from the core plugin.
 * @param msg      The debug message to send.
 * @param ...      Formatted arguments for msg.
 *
 * @return void
 */
native void L4D2PB_DebugMsg(int req, const char[] msg, any...);

/**
 * Registers a box to core and adds it to the box rotation.
 *
 * @param type      The box type (BoxType enum).
 * @param name      A short/code name for the box.
 * @param display   The box display name.      
 *
 * @return 0 on success or 1 on error.
 */
native int L4D2PB_RegisterBox(BoxType type, const char[] name, const char[] display);

/**
 * Unloads a box from the core.
 *
 * @param name      A short/code name for the box.
 *
 * @return 0 on success or 1 on error.
 */
native int L4D2PB_UnloadBox(const char[] name);
```

### Forwards
Here are core (global) forwards you may call while developing your own box types. Take a look at [`scripting/l4d2pb-box-test.sp`](./scripting/l4d2pb-box-test.sp) for a basic example.

```c
/**
 * Called when the core plugin is initially loaded (in OnPluginStart()).
 * 
 */
public void L4D2PB_OnCoreLoaded();

/**
 * Called when the core plugin executes its config (in OnConfigsExecuted()).
 * 
 * @note This is where I recommend registering a box.
 * 
 */
public void L4D2PB_OnCoreCfgsLoaded();

/**
 * Called when the core plugin is unloaded (in OnPluginEnd()).
 * 
 */
public void L4D2PB_OnCoreUnloaded();

/**
 * Called when a box is opened.
 * 
 * @param type      The type of box opened.
 * @param boxName   The box short/code name that was opened.
 * @param userid    The user ID who opened the box.
 * 
 */
public void L4D2PB_BoxOpened(int type, const char[] boxName, int userId);
```

## Provided Boxes
Here are a list of boxes provided in this repository. Boxes are developed as separate plugins that use forwards and natives from the core plugin to register the box and such.

### [Damage](./scripting/l4d2pb-box-dmg.sp)
This is a damage box registered under the **Bad** category. It is enabled by default and damages the user and potentially players around them depending on the ConVar values set when opened.

#### ConVars & Configuration
The configuration file may be found at `cfg/sourcemod/plugin.l4d2pb-box-dmg.cfg`.

```bash
// This file was auto-generated by SourceMod (v1.11.0.6968)
// ConVars for plugin "l4d2pb-box-dmg.smx"


// Enables the damage box
// -
// Default: "1"
// Minimum: "0.000000"
// Maximum: "1.000000"
l4d2pb_box_dmg_enabled "1"

// The maximum damage to apply.
// -
// Default: "100.0"
// Minimum: "1.000000"
l4d2pb_box_dmg_max "100.0"

// The minimum damage to apply.
// -
// Default: "5.0"
// Minimum: "1.000000"
l4d2pb_box_dmg_min "5.0"

// The maximum radius to damage survivors in. 0 = disables damaging others.
// -
// Default: "500.0"
// Minimum: "0.000000"
l4d2pb_box_dmg_radius_max "500.0"

// The mimimum radius to damage survivors in.
// -
// Default: "200.0"
// Minimum: "0.000000"
l4d2pb_box_dmg_radius_min "200.0"

// If 1, when damage is applied, each player affected receives a random damage count.
// -
// Default: "1"
// Minimum: "0.000000"
// Maximum: "1.000000"
l4d2pb_box_dmg_rand_per_player "1"
```

### [Test](./scripting/l4d2pb-box-test.sp)
This is a test box registered under the **Mid** category. It is disabled by default and simply prints a message to chat.

#### ConVars & Configuration
The configuration file may be found at `cfg/sourcemod/plugin.l4d2pb-box-test.cfg`.

```bash
// This file was auto-generated by SourceMod (v1.11.0.6968)
// ConVars for plugin "l4d2pb-box-test.smx"


// Enables the test box
// -
// Default: "0"
// Minimum: "0.000000"
// Maximum: "1.000000"
l4d2pb_box_test_enabled "0"
```

## Credits
* [Christian Deacon](https://github.com/gamemann)